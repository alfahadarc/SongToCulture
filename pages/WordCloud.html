<!DOCTYPE html>
<meta charset="utf-8" />
<title>Lyrics Word Cloud by Year</title>
<link
  href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap"
  rel="stylesheet"
/>
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/d3-cloud@1/build/d3.layout.cloud.js"></script>

<style>
  :root {
    color-scheme: dark;
    --panel: rgba(15, 20, 42, 0.78);
    --panel-2: rgba(255, 255, 255, 0.04);
    --accent: #7dd3fc;
    --accent-2: #c084fc;
    --text: #e7eaf1;
    --muted: #9aa3b2;
    --border: rgba(255, 255, 255, 0.08);
    --shadow: 0 12px 38px rgba(0, 0, 0, 0.45);
  }
  * {
    box-sizing: border-box;
  }
  html,
  body {
    height: 100%;
    overflow: hidden;
  }
  body {
    margin: 0;
    min-height: 100vh;
    font-family: "Space Grotesk", "Inter", system-ui, -apple-system, Segoe UI,
      Roboto, Helvetica, Arial;
    background: radial-gradient(1200px 1200px at 78% -10%, #0ea5e9 0%, transparent 42%),
      radial-gradient(1200px 900px at 0% 110%, #8b5cf6 0%, transparent 32%),
      linear-gradient(180deg, #0b1020 0%, #0b1020 100%);
    color: var(--text);
    padding: 0;
  }
  main {
    height: 100vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  h1 {
    margin: 0;
    font-size: clamp(24px, 4vw, 34px);
    letter-spacing: 0.4px;
  }
  p {
    margin: 0;
  }
  .layout {
    flex: 1;
    display: grid;
    grid-template-columns: 210px 1fr;
    gap: 0;
    align-items: stretch;
    min-height: 0;
  }
  .panel {
    background: var(--panel);
    border: 1px solid var(--border);
    border-radius: 0;
    box-shadow: none;
  }
  .years {
    display: flex;
    flex-direction: column;
    min-height: 0;
    overflow: hidden;
  }
  .panel-head {
    padding: 14px 12px 8px;
    border-bottom: 1px solid var(--border);
  }
  .eyebrow {
    font-size: 13px;
    letter-spacing: 0.4px;
    color: var(--accent);
    text-transform: uppercase;
    margin-bottom: 6px;
  }
  .hint {
    font-size: 12px;
    color: var(--muted);
    margin-top: 6px;
    line-height: 1.5;
  }
  .mode-toggle {
    display: inline-flex;
    background: var(--panel-2);
    border-radius: 999px;
    padding: 4px;
    gap: 6px;
    margin-top: 10px;
  }
  .mode-toggle button {
    all: unset;
    padding: 8px 12px;
    font-weight: 600;
    font-size: 13px;
    border-radius: 999px;
    cursor: pointer;
    color: var(--muted);
  }
  .mode-toggle button.active {
    background: linear-gradient(135deg, rgba(125, 211, 252, 0.16), rgba(192, 132, 252, 0.16));
    color: var(--text);
    box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.08);
  }
  .year-list {
    flex: 1;
    overflow-y: auto;
    padding: 6px 8px 10px;
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
  .year-list::-webkit-scrollbar {
    width: 6px;
  }
  .year-list::-webkit-scrollbar-thumb {
    background: rgba(255, 255, 255, 0.18);
    border-radius: 999px;
  }
  .year-row {
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 12px 12px;
    border-radius: 8px;
    background: var(--panel-2);
    border: 1px solid var(--border);
    color: var(--text);
    cursor: pointer;
    transition: background 0.15s ease, border-color 0.15s ease, box-shadow 0.15s ease,
      transform 0.15s ease;
  }
  .year-row.active {
    background: linear-gradient(120deg, rgba(125, 211, 252, 0.18), rgba(192, 132, 252, 0.18));
    border-color: rgba(255, 255, 255, 0.24);
    box-shadow: 0 10px 20px rgba(0, 0, 0, 0.28);
  }
  .year-row:not(.active):hover {
    background: linear-gradient(120deg, rgba(125, 211, 252, 0.12), rgba(192, 132, 252, 0.12));
    border-color: rgba(255, 255, 255, 0.18);
    box-shadow: 0 8px 14px rgba(0, 0, 0, 0.22);
    transform: translateX(2px);
  }
  .year-row.active:hover {
    transform: translateX(2px);
  }
  .year-label {
    font-size: medium;
    font-weight: 900;
    letter-spacing: 0.2px;
  }
  .year-meta {
    font-size: 12px;
    color: var(--muted);
  }
  .viz {
    padding: 12px 16px;
    display: flex;
    flex-direction: column;
    gap: 10px;
    min-height: 0;
    overflow: hidden;
  }
  .header {
    display: flex;
    align-items: baseline;
    justify-content: space-between;
    gap: 12px;
    flex-wrap: wrap;
  }
  .subhead {
    color: var(--muted);
    font-size: 14px;
  }
  .pill {
    padding: 8px 12px;
    border-radius: 999px;
    background: rgba(255, 255, 255, 0.06);
    font-size: 12px;
    color: var(--muted);
  }
  .cloud-wrap {
    position: relative;
    flex: 1;
    min-height: 0;
    height: 100%;
    background: radial-gradient(900px 700px at 65% 20%, rgba(125, 211, 252, 0.08), transparent),
      radial-gradient(900px 700px at 10% 80%, rgba(192, 132, 252, 0.08), transparent),
      rgba(6, 10, 24, 0.8);
    border-radius: 12px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow);
    overflow: hidden;
  }
  #wordCloud {
    width: 100%;
    height: 100%;
  }
  .overlay {
    position: absolute;
    inset: 12px 12px auto auto;
    background: rgba(0, 0, 0, 0.24);
    border-radius: 12px;
    padding: 8px 12px;
    font-size: 12px;
    color: var(--muted);
  }
  .empty {
    position: absolute;
    inset: 0;
    display: grid;
    place-items: center;
    color: var(--muted);
    font-size: 14px;
    letter-spacing: 0.2px;
  }
  .footer-note {
    font-size: 12px;
    color: var(--muted);
    display: flex;
    gap: 10px;
    align-items: center;
  }
  .key-dot {
    width: 9px;
    height: 9px;
    border-radius: 999px;
    background: var(--accent);
    box-shadow: 0 0 12px var(--accent);
  }
  @media (max-width: 1100px) {
    .layout {
      grid-template-columns: 1fr;
    }
    .years {
      min-height: auto;
      max-height: 320px;
    }
    .viz {
      min-height: auto;
    }
  }
</style>

<main>
  <div class="layout">
    <aside class="panel years">
      <div class="panel-head">
        <div class="eyebrow">Timeline</div>
        <div class="mode-toggle" id="modeToggle">
          <button class="active" data-mode="year">By year</button>
          <button data-mode="decade">By decade</button>
        </div>
      </div>
      <div class="year-list" id="periodList" aria-label="Year list"></div>
    </aside>

    <section class="panel viz">
      <div class="header">
        <div>
          <div class="eyebrow" id="cloudModeLabel">Loading...</div>
        </div>
        <div class="pill" id="legendBadge">Top 60 words 路 stopwords removed</div>
      </div>

      <div class="cloud-wrap" id="cloudWrap">
        <svg id="wordCloud"></svg>
        <div class="overlay" id="overlayNote">Hover the words to read them clearly.</div>
        <div class="empty" id="emptyState" style="display: none">No words available for this period.</div>
      </div>

    </section>
  </div>
</main>

<script>
  const DATA_URL = "./Data/wordcloud_data.json";

  const state = {
    mode: "year",
    data: null,
    activeKey: null,
  };

  const listEl = document.getElementById("periodList");
  const titleEl = document.getElementById("cloudTitle");
  const subEl = document.getElementById("cloudSubtitle");
  const modeLabelEl = document.getElementById("cloudModeLabel");
  const emptyEl = document.getElementById("emptyState");
  const overlayNote = document.getElementById("overlayNote");
  const cloudWrap = document.getElementById("cloudWrap");
  const svg = d3.select("#wordCloud");

  fetch(DATA_URL)
    .then((resp) => {
      if (!resp.ok) throw new Error("Unable to load word cloud data.");
      return resp.json();
    })
    .then((raw) => {
      state.data = normalizeData(raw);
      buildList();
      bindModeToggle();
      window.addEventListener("resize", () => {
        if (state.activeKey) {
          const current = getCurrentItems().find(
            (d) => String(d.key) === String(state.activeKey)
          );
          if (current) renderCloud(current.words);
        }
      });
    })
    .catch((err) => {
      console.error(err);
      if (titleEl) titleEl.textContent = "Failed to load data";
      if (subEl) subEl.textContent = "Check that Data/wordcloud_data.json is reachable.";
      emptyEl.style.display = "grid";
      overlayNote.style.display = "none";
    });

  function normalizeData(raw) {
    const hydrate = (arr) =>
      (arr || []).map((d) => ({
        key: d.key,
        label: d.label,
        tracks: d.tracks,
        words: (d.words || []).map((w) => ({ text: w.text, value: +w.value })),
      }));
    return {
      years: hydrate(raw.years).sort((a, b) => a.key - b.key),
      decades: hydrate(raw.decades).sort((a, b) => a.key - b.key),
      meta: raw.meta || {},
    };
  }

  function getCurrentItems() {
    return state.mode === "year" ? state.data.years : state.data.decades;
  }

  function buildList() {
    listEl.innerHTML = "";
    const items = getCurrentItems();
    const best = items.reduce(
      (top, cur) => (top && top.tracks > cur.tracks ? top : cur),
      items[0] || null
    );

    items.forEach((item) => {
      const btn = document.createElement("button");
      btn.className = "year-row";
      btn.type = "button";
      btn.dataset.key = item.key;
      btn.innerHTML = `
        <div class="year-label">${item.label}</div>
        <div class="year-meta">${formatNumber(item.tracks)} tracks</div>
      `;
      btn.addEventListener("click", () => setActive(item.key, { center: true }));
      listEl.appendChild(btn);
    });

    const startItem = best || items[0];
    if (startItem) {
      setActive(startItem.key);
    }
  }

  function bindModeToggle() {
    const toggle = document.getElementById("modeToggle");
    toggle.querySelectorAll("button").forEach((btn) => {
      btn.addEventListener("click", () => {
        const nextMode = btn.dataset.mode;
        if (nextMode === state.mode) return;
        toggle.querySelectorAll("button").forEach((b) => b.classList.remove("active"));
        btn.classList.add("active");
        state.mode = nextMode;
        buildList();
      });
    });
  }

  function setActive(key, opts = {}) {
    const center = Boolean(opts.center);
    const items = getCurrentItems();
    const match = items.find((d) => String(d.key) === String(key));
    if (!match) return;
    state.activeKey = String(match.key);

    listEl.querySelectorAll(".year-row").forEach((el) => {
      el.classList.toggle("active", String(el.dataset.key) === state.activeKey);
    });

    if (center) {
      const target = listEl.querySelector(`.year-row[data-key="${match.key}"]`);
      if (target) {
        target.scrollIntoView({ block: "center", behavior: "smooth" });
      }
    }

    updateHeader(match);
    renderCloud(match.words);
  }

  function setModeLabel(item) {
    if (!modeLabelEl) return;
    if (!item) {
      modeLabelEl.textContent = state.mode === "year" ? "Select a year" : "Select a decade";
      return;
    }
    modeLabelEl.textContent = `${item.label} YEAR 路 ${formatTracksLabel(item.tracks)}`;
  }

  function updateHeader(item) {
    setModeLabel(item);
    if (titleEl) titleEl.textContent = item.label;
    if (subEl) {
      const trackLabel = formatTracksLabel(item.tracks);
      const note = state.data.meta?.words_per_bucket
        ? `Top ${state.data.meta.words_per_bucket} words`
        : "Word counts";
      subEl.textContent = `${trackLabel} 路 ${note} 路 stopwords removed`;
    }
    overlayNote.textContent =
      state.mode === "year"
        ? "Words sized by usage across all tracks in this year."
        : "Words sized by usage across all tracks in this decade.";
  }

  function renderCloud(words) {
    if (!words || !words.length) {
      emptyEl.style.display = "grid";
      svg.selectAll("*").remove();
      return;
    }
    emptyEl.style.display = "none";

    const { width, height } = cloudWrap.getBoundingClientRect();
    svg.selectAll("*").remove();

    const sizeRange = [14, Math.max(28, Math.min(width, height) / 5)];
    const size = d3
      .scaleSqrt()
      .domain(d3.extent(words, (d) => d.value))
      .range(sizeRange);
    const color = d3
      .scaleLinear()
      .domain([0, words.length * 0.6, words.length])
      .range(["#7dd3fc", "#c084fc", "#f472b6"]);

    const layout = d3.layout
      .cloud()
      .size([width, height])
      .padding(3)
      .rotate(() => (Math.random() > 0.82 ? 90 : 0))
      .font("Space Grotesk")
      .fontSize((d) => size(d.value))
      .words(words.map((d) => ({ ...d })))
      .on("end", (layoutWords) => {
        const g = svg
          .attr("width", width)
          .attr("height", height)
          .append("g")
          .attr("transform", `translate(${width / 2},${height / 2})`);

        g.selectAll("text")
          .data(layoutWords, (d) => d.text)
          .enter()
          .append("text")
          .style("font-family", "Space Grotesk, Inter, system-ui")
          .style("font-size", (d) => `${d.size}px`)
          .style("fill", (d, i) => color(i))
          .style("font-weight", 600)
          .attr("text-anchor", "middle")
          .attr("transform", (d) => `translate(${d.x},${d.y}) rotate(${d.rotate})`)
          .text((d) => d.text)
          .append("title")
          .text((d) => `${d.text}: ${formatNumber(d.value)}`);
      });

    layout.start();
  }

  function formatTracksLabel(num) {
    const total = num || 0;
    const suffix = total === 1 ? "track" : "tracks";
    return `${formatNumber(total)} ${suffix}`;
  }

  function formatNumber(num) {
    return (num || 0).toLocaleString();
  }
</script>
